<pngx-widget-frame
  *pngxIfPermissions="{ action: PermissionAction.View, type: PermissionType.Document }"
  [title]="savedView.name"
  [loading]="loading"
  [draggable]="savedView"
  >

  @if (documents.length) {
    <a class="btn-link text-decoration-none" header-buttons [routerLink]="[]" (click)="showAll()" i18n>Show all</a>
  }

  <div content class="wrapper fade" [class.show]="show">
  @if (displayMode === DisplayMode.TABLE) {
    <table class="table table-hover mb-0 mt-n2 align-middle">
      <thead>
        <tr>
          @for (field of displayFields; track field; let i = $index) {
            @if (displayFields.includes(field)) {
              <th
                scope="col"
                [ngClass]="{
                  'd-none d-md-table-cell': i > 1,
                  'w-25': field === DisplayField.CREATED || field === DisplayField.ADDED
                }">
                {{ getColumnTitle(field) }}
              </th>
            }
          }
        </tr>
      </thead>
      <tbody>
        @for (doc of documents; track doc.id; let i = $index) {
          <tr>
            @for (field of displayFields; track field; let j = $index) {
              <td class="py-2 py-md-3 position-relative" [ngClass]="{ 'd-none d-md-table-cell': j > 1 }">
                @if (loading && show) {
                  <div class="placeholder-glow text-start">
                    <span class="placeholder bg-secondary w-50" [ngStyle]="{ opacity: 1 - (i * 1/documents.length) }"></span>
                  </div>
                } @else {
                  @switch (field) {
                    @case (DisplayField.ADDED) {
                      <a routerLink="/documents/{{doc.id}}" class="btn-link text-dark text-decoration-none py-2 py-md-3" title="Open document" i18n-title>{{doc.added | customDate}}</a>
                    }
                    @case (DisplayField.CREATED) {
                      <a routerLink="/documents/{{doc.id}}" class="btn-link text-dark text-decoration-none py-2 py-md-3" title="Open document" i18n-title>{{doc.created_date | customDate}}</a>
                    }
                    @case (DisplayField.TITLE) {
                      <a routerLink="/documents/{{doc.id}}" title="Open document" i18n-title class="btn-link text-dark text-decoration-none py-2 py-md-3">{{doc.title | documentTitle}}</a>
                    }
                    @case (DisplayField.CORRESPONDENT) {
                      @if (doc.correspondent) {
                        <a class="btn-link text-dark text-decoration-none" type="button" (click)="clickCorrespondent(doc.correspondent, $event)" title="Filter by correspondent" i18n-title>{{(doc.correspondent$ | async)?.name}}</a>
                      }
                    }
                    @case (DisplayField.TAGS) {
                      @for (t of doc.tags$ | async; track t) {
                        <pngx-tag [tag]="t" class="ms-1" (click)="clickTag(t.id, $event)" [clickable]="true" linkTitle="Filter by tag" i18n-title></pngx-tag>
                      }
                    }
                    @case (DisplayField.DOCUMENT_TYPE) {
                      @if (doc.document_type) {
                        <a class="btn-link text-dark text-decoration-none" type="button" (click)="clickDocType(doc.document_type, $event)" title="Filter by document type" i18n-title>{{(doc.document_type$ | async)?.name}}</a>
                      }
                    }
                    @case (DisplayField.STORAGE_PATH) {
                      @if (doc.storage_path) {
                        <a class="btn-link text-dark text-decoration-none" type="button" (click)="clickStoragePath(doc.storage_path, $event)" title="Filter by storage path" i18n-title>{{(doc.storage_path$ | async)?.name}}</a>
                      }
                    }
                  }
                  @if (field.startsWith(DisplayField.CUSTOM_FIELD)) {
                    <pngx-custom-field-display [document]="doc" [fieldDisplayKey]="field"></pngx-custom-field-display>
                  }
                  @if (j === displayFields.length - 1) {
                    <div class="btn-group position-absolute top-50 end-0 translate-middle-y" (mouseleave)="popupPreview.close()">
                      <pngx-preview-popup [document]="doc" linkClasses="btn px-4 btn-dark border-dark-subtle" #popupPreview>
                        <i-bs width="0.8em" height="0.8em" name="eye"></i-bs>
                      </pngx-preview-popup>
                      <a [href]="getDownloadUrl(doc)" class="btn px-4 btn-dark border-dark-subtle" title="Download" i18n-title (click)="$event.stopPropagation()">
                        <i-bs width="0.8em" height="0.8em" name="download"></i-bs>
                      </a>
                    </div>
                  }
                }
              </td>
            }
          </tr>
        }
      </tbody>
    </table>
  } @else if (displayMode === DisplayMode.SMALL_CARDS) {
    <div class="row row-cols-paperless-cards my-n2">
      @for (d of documents; track d.id; let i = $index) {
        @defer {
          <pngx-document-card-small
            class="p-0"
            [ngStyle]="{ opacity: !loading && show ? 1 : 1 - (i * 1/documents.length) }"
            (dblClickDocument)="openDocumentDetail(d)"
            [document]="!loading && show ? d : null"
            [displayFields]="displayFields"
            (clickTag)="clickTag($event)"
            (clickCorrespondent)="clickCorrespondent($event)"
            (clickStoragePath)="clickStoragePath($event)"
            (clickDocumentType)="clickDocumentType($event)">
          </pngx-document-card-small>
        } @placeholder (minimum 500ms) {
          <div class="col p-2 h-100">
            <div class="card placeholder-glow document-card">
              <div class="border-bottom doc-img-container rounded-top">
                <div class="card-img doc-img">
                  <div class="placeholder bg-secondary w-100 card-img doc-img"></div>
                </div>
              </div>

              <div class="card-body bg-light p-2">
                <div class="placeholder bg-secondary w-100"></div>
                <div class="placeholder bg-secondary w-50"></div>
              </div>

              <div class="card-footer pt-0 pb-2 px-2">
                <div class="list-group list-group-flush border-0 pt-1 pb-2 card-info">
                  <div class="placeholder bg-secondary w-100"></div>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <div class="btn-group w-100">
                    <button class="btn btn-sm btn-outline-secondary placeholder bg-secondary"></button>
                    <button class="btn btn-sm btn-outline-secondary placeholder bg-secondary"></button>
                    <button class="btn btn-sm btn-outline-secondary placeholder bg-secondary"></button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        }
      }
    </div>
  } @else if (displayMode === DisplayMode.LARGE_CARDS) {
    <div class="row my-n2">
      @for (d of documents; track d.id; let i = $index) {
        @defer {
          <pngx-document-card-large
            (dblClickDocument)="openDocumentDetail(d)"
            [document]="!loading && show ? d : null"
            [ngStyle]="{ opacity: !loading && show ? 1 : 1 - (i * 1/documents.length) }"
            [displayFields]="displayFields"
            (clickTag)="clickTag($event)"
            (clickCorrespondent)="clickCorrespondent($event)"
            (clickStoragePath)="clickStoragePath($event)"
            (clickDocumentType)="clickDocumentType($event)"
            (clickMoreLike)="clickMoreLike(d.id)">
          </pngx-document-card-large>
        }
        @placeholder (minimum 500ms) {
          <div class="card document-card-large mb-3 shadow-sm bg-light placeholder-glow">
            <div class="row g-0">
              <div class="col-md-2 doc-img-container rounded-start">
                <div class="placeholder bg-secondary w-100 card-img doc-img border-end rounded-start"></div>
              </div>
              <div class="col">
                <div class="card-body">

                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title w-100">
                      <div class="placeholder bg-secondary w-75 mb-3">&nbsp;</div>
                    </h5>
                  </div>

                  <div class="placeholder bg-secondary w-100 d-block mb-2"></div>
                  <div class="placeholder bg-secondary w-75 d-block mb-2"></div>
                  <div class="placeholder bg-secondary w-25 d-block"></div>

                  <div class="d-flex flex-column flex-md-row align-items-md-center">
                    <div class="btn-group">
                      <div class="placeholder btn btn-sm btn-outline-secondary bg-secondary" style="width: 60px;">&nbsp;</div>
                      <div class="placeholder btn btn-sm btn-outline-secondary bg-secondary" style="width: 60px;">&nbsp;</div>
                      <div class="placeholder btn btn-sm btn-outline-secondary bg-secondary" style="width: 60px;">&nbsp;</div>
                      <div class="placeholder btn btn-sm btn-outline-secondary bg-secondary" style="width: 60px;">&nbsp;</div>
                    </div>

                    <div class="list-group list-group-horizontal border-0 card-info ms-md-auto mt-2 mt-md-0">
                      <div class="placeholder list-group-item bg-secondary w-25">&nbsp;</div>
                      <div class="placeholder list-group-item bg-secondary w-25">&nbsp;</div>
                      <div class="placeholder list-group-item bg-secondary w-25">&nbsp;</div>
                      <div class="placeholder list-group-item bg-secondary w-25">&nbsp;</div>
                      <div class="placeholder list-group-item bg-secondary w-25">&nbsp;</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        }
      }
    </div>
  } @else {
    <p i18n class="text-center text-muted mb-0 fst-italic">No documents</p>
  }

  </div>
</pngx-widget-frame>
